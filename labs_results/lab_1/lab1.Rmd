---
title: "Лабораторная №1"
author: "Сердюков Дмитрий"
date: "2022-10-29"
output: html_document
---

## Задание 1

### 1. Постановка задачи

Дан файл с данными lab1_e1.csv. Необходимо написать функцию fix_data, которая получает на вход набор данных, у которого в некоторых значениях числовых переменных добавлен пробел между цифрами. Функция должна избавиться от этого пробела и вернуть числовым переменным их числовой тип.

### 2. Данные

Посмотрим на типы столбцов, которые автоматически считались функцией read.csv:

```{r}
df_e1 <- read.csv('data/lab1_e1.csv')
sapply(df_e1, typeof)
```

Содержимое файла:

```{r}
head(df_e1)
```

### 3. План решения

Функция fix_data():

-   идем по всем столбцам

-   проверяем нет ли буквенных символов в столбце с помощью регулярных выражений

-   убираем пробелы и приводим к числовому типу (double)

-   возвращаем исправленный data.frame

```{r}
fix_data <- function(df) {
  # идем по всем столбцам
  for (i in names(df)) {
    # проверяем нет ли буквенных символов в столбце
    if (length(grep('[a-z]', df[[i]], ignore.case = T)) == 0) {
      # убираем пробелы и приводим к даблу
      df[[i]] <- as.double(gsub(" ", "", df[[i]], fixed = TRUE))
    }
  }
  return (df)
}
```

### 4. Результаты

Посмотрим на типы столбцов, которые получились после преобрахования:

```{r}
df_e1_fixed <- fix_data(df_e1)
sapply(df_e1_fixed, typeof)
```

Содержимое data.frame:

```{r}
head(df_e1_fixed)
```

Как мы видим, три столбца преобразовались в тип double, остальные остались без изменений

## Задание 2

### 1. Постановка задачи

Дан файл с данными lab1_e2.Rdata. Допустим, в рамках некоторого медицинского исследования тестировалась эффективность новой вакцины от вируса гриппа. Одной из целей исследования являлось изучить динамику температуры тела пациентов на протяжении недели после вакцинации. Пациенты должны были каждый день приходить на осмотр, где у них измеряли температуру. Каждый из семи дней экспериментатор вносил в таблицу id пациента и его температуру. После окончания исследования выяснилось, что некоторые пациенты не смогли посетить все семь приемов. Кто-то после первого раза больше не приходил на обследование, кто-то пропустил некоторые дни и т.д. Для чистоты исследования врачам необходимо отобрать из всех пациентов только тех, кто посетили каждый из семи приемов. Все данные хранятся в следующем формате: в списке all_data сохранены семь датафреймов, с двумя колонками:

1.  id - закодированное имя пациента

2.  temp - значения температуры.

Задача - написать функцию get_id, которая получает на вход такого рода список, состоящий из семи датафрэймов. Функция, должна вернуть новый датафрэйм, в котором будут две переменные id и mean_temp - среднее значение температуры за неделю только тех пациентов, которые посетили все семь приемов.

### 2. Данные

После загрузки данных, посмотрем, что находится в all_data:

```{r}
load('data/lab1_e2.Rdata')
str(all_data)
```

Как видим, здесь действительно лист из 7 data.frame

### 3. План решения

-   сливаем все 7 датафреймов в один

-   считаем кол-во встречаний каждого id

-   группируем по id и считаем среднюю температуру

-   джойним два этих датафрейма по id

-   выбираем только те id, число встречаний которых больше 7

```{r}
get_id <- function(df) {
  # сливаем все в один датафрейм
  full_df <- do.call("rbind", df)
  
  # группируем по id и считаем среднюю температуру
  mean_temp_df <- setNames(aggregate(temp ~ id, full_df, mean), c("id", "mean_temp"))
  
  # добавляем столбец с числом встречаний id в full_df
  id_count_df <- setNames(aggregate(temp ~ id, full_df, length), c("id", "count"))
  
  # джойним эти фреймы
  result <- merge(mean_temp_df, id_count_df, by = 'id')
  
  # выбираем только те, где пациент появлялся 7 раз
  result <- subset(result, count == 7, select = c('id', 'mean_temp'))
  
  # меняю старую нумерацию строк на новую
  row.names(result) <- c(1:nrow(result))
  return (result)
}
```

### 4. Результаты

Посмотрим на получившийся датафрейм из функции get_id:

```{r}
df_e2 <- get_id(all_data)
print(df_e2, print.gap=4)
```

Как мы видим, получилось 14 пациентов, которые добросовестно прошли курс диагностики. Теперь мы можем использовать эти данные в последующих исследованиях

```{r}
hist(df_e2$mean_temp, 
     xlab = "Температура",
     ylab = "Частота",
     main = "Гистограмма средней температуры пациентов за 7 дней"
     )
```
